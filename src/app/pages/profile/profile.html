<div class="max-w-4xl mx-auto space-y-6" *ngIf="profile$ | async as profile">

  <!-- Profile Card -->
  <div class="bg-white rounded-xl shadow p-6 flex flex-col sm:flex-row items-center sm:items-start gap-6">

    <!-- Avatar -->
    <div class="relative w-32 h-32">

      <!-- Profile image -->
      <img *ngIf="profile.profilePicture; else defaultAvatar"
           [src]="profile.profilePicture"
           alt="Profile picture"
           class="w-32 h-32 rounded-full object-cover border"/>

      <!-- Default avatar -->
      <ng-template #defaultAvatar>
        <div class="w-32 h-32 rounded-full flex items-center justify-center text-white text-6xl font-normal select-none"
             [ngStyle]="{ 'background-color': getAvatarColor(profile.username) }">
          {{ getInitial(profile.username) }}
        </div>
      </ng-template>

      <!-- Always present file input (hidden) -->
      <input type="file" accept="image/*" class="hidden" #fileInput (change)="onProfilePictureSelected($event)"/>

      <!-- Pencil button (owner only) -->
      <button *ngIf="isOwner$ | async"
              type="button" (click)="fileInput.click()"
              class="absolute bottom-0 right-0 bg-gray-900 text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700"
              title="Change profile picture">
        ✎
      </button>
    </div>

    <!-- User Info -->
    <form [formGroup]="profileForm" class="flex-1 text-center sm:text-left space-y-2">
      <!-- Display Name -->
      <div>
        <ng-container *ngIf="editMode; else viewDisplayName">
          <label class="font-semibold">Display Name</label>
          <input type="text" formControlName="displayName" class="border rounded p-1 w-full"/>
        </ng-container>
        <ng-template #viewDisplayName>
          <h1 class="text-2xl font-bold">{{ profile.displayName || 'Your Name' }}</h1>
        </ng-template>
      </div>

      <!-- Username -->
      <div>
        <ng-container *ngIf="editMode; else viewUsername">
          <label class="font-semibold">Username</label>
          <input type="text" formControlName="username" class="border rounded p-1 w-full"/>
          <!-- Live feedback -->
            <p *ngIf="usernameAvailable === true" class="text-green-600 text-sm">
              ✓ Username available
            </p>
            <p *ngIf="usernameAvailable === false" class="text-red-600 text-sm">
              ✕ Username taken
            </p>
        </ng-container>
        <ng-template #viewUsername>
          <p class="text-gray-500">@{{ profile.username || 'username' }}</p>
        </ng-template>
      </div>

      <!-- Bio -->
      <div>
        <ng-container *ngIf="editMode; else viewBio">
          <label class="font-semibold">Bio</label>
          <textarea formControlName="bio" class="border rounded p-1 w-full"></textarea>
        </ng-container>
        <ng-template #viewBio>
          <p class="text-gray-700 max-w-xl">{{ profile.bio || '' }}</p>
        </ng-template>
      </div>
    </form>

    <!-- Edit Profile button (owner only) -->
    <div class="self-center sm:self-start" *ngIf="isOwner$ | async">
      <!-- Edit button -->
      <button *ngIf="!editMode"
              (click)="enterEditMode()"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
        Edit Profile
      </button>

      <!-- Save / Cancel buttons -->
      <div *ngIf="editMode" class="flex gap-2">
        <button 
            *ngIf="hasChanges$ | async" (click)="saveEditProfile()"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
          Save
        </button>
        <button (click)="cancelEditProfile()"
                class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
          Cancel
        </button>
      </div>
    </div>

  </div>

  <!-- Stats (Posts, Friends, Groups) -->
  <div class="grid grid-cols-3 gap-4 text-center">
    <div class="bg-white rounded-lg shadow p-4">
      <p class="text-xl font-bold">0</p>
      <p class="text-gray-500 text-sm">Posts</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <p class="text-xl font-bold">0</p>
      <p class="text-gray-500 text-sm">Friends</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <p class="text-xl font-bold">0</p>
      <p class="text-gray-500 text-sm">Groups</p>
    </div>
  </div>

  <!-- Crop Modal -->
  <div *ngIf="cropImageSrc && (isOwner$ | async)"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-4 rounded-lg relative w-full max-w-sm h-auto flex flex-col items-center">
      <h2 class="text-lg font-bold mb-4">Adjust Profile Picture</h2>
      <div class="relative w-64 h-64 rounded-full overflow-hidden border-4 border-gray-200 shadow-inner touch-none"
           (mousedown)="startDrag($event)" (mousemove)="drag($event)" (mouseup)="endDrag()" (mouseleave)="endDrag()"
           (touchstart)="startDrag($event)" (touchmove)="drag($event)" (touchend)="endDrag()" (touchcancel)="endDrag()">
        <img [src]="cropImageSrc" class="absolute"
             [style.left.px]="cropX" [style.top.px]="cropY"
             [style.transform]="'scale(' + cropScale + ')'" draggable="false"/>
      </div>
      <input type="range" min="0.5" max="3" step="0.01" [value]="cropScale"
             (input)="cropScale = $any($event.target).valueAsNumber" class="mt-4 w-64"/>
      <div class="mt-4 flex gap-2">
        <button (click)="saveCroppedProfilePicture()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save</button>
        <button (click)="cropImageSrc = null" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Cancel</button>
      </div>
    </div>
  </div>

</div>
